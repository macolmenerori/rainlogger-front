# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a React/TypeScript web application for RainLogger, a rainfall monitoring system. The frontend allows users to log and track rainfall amounts.

## Development Commands

- **Development server**: `pnpm dev` (React Router dev server on port 3000)
- **Build**: `pnpm build` (React Router build, output to `dist/`)
- **Preview**: `pnpm preview` (preview production build locally on port 3000)
- **Test**: `pnpm test` (Vitest single run)
- **Test (watch)**: `pnpm test:watch` (Vitest interactive watch mode)
- **Test (UI)**: `pnpm test:ui` (Vitest browser-based UI dashboard)
- **Test (coverage)**: `pnpm test:coverage` (Vitest with v8 coverage report)
- **Linting**: `pnpm lint` (ESLint with auto-fix)
- **Formatting**: `pnpm prettify` (Prettier formatting)
- **Type checking**: `pnpm types` (React Router typegen + TypeScript compiler check)

## Architecture

### React Router Framework Mode
This project uses **React Router v7 in framework mode** (SPA, no SSR).

- **Config**: `react-router.config.ts` - framework settings (`ssr: false`, `buildDirectory: 'dist'`)
- **Root**: `app/root.tsx` - i18n initialization (side-effect import), font imports, `App` component (with `ThemeProvider` + `UserProvider` + `<Outlet />`), and re-exports of `Layout` and `ErrorBoundary`
- **Routes**: `app/routes.ts` - route definitions using `@react-router/dev/routes`
- **Auto-generated types**: `.react-router/types/` (gitignored, generated by `react-router typegen`)

### Route Structure
- `/login` → `app/pages/Login/Login.tsx` (public, no auth required)
- **Protected by AuthGuard layout** (`app/ui/AuthGuard/AuthGuard.tsx`):
  - `/` → `app/pages/MainPage/MainPage.tsx`
  - `/newlog` → `app/pages/NewLog/NewLog.tsx`
  - `/watchlogs` → `app/pages/WatchLogs/WatchLogs.tsx`

### Core Structure
- **Pages**: `app/pages/<PageName>/<PageName>.tsx` - each page exports a default component and a `meta()` function
- **Components**: `app/components/` - shared UI components
  - `LanguageSwitcher/` - Material-UI language switcher component for i18n
  - `Navbar/` - Responsive app navbar (sticky MUI AppBar); shown on all protected routes via AuthGuard. Contains clickable title (navigates to `/`), `LanguageSwitcher`, and logout button. Uses a `Drawer` for mobile (< 600px) layout
- **UI Components**: `app/ui/` - core UI infrastructure
  - `AuthGuard/` - Layout route component that checks authentication; shows spinner while checking, redirects to `/login` if unauthenticated, renders `<Navbar />` + `<Outlet />` if authenticated
  - `Layout/` - HTML shell component with dynamic lang attribute
  - `ErrorBoundary/` - Error boundary component with translated messages
  - `theme/` - MUI theme configuration
    - `theme.json` - source of truth for palette and typography values (dark mode)
    - `theme.ts` - `createAppTheme(mode)` factory using MUI's `createTheme()`; exports pre-built `appTheme`
    - `ThemeContext.tsx` - `ThemeProvider` component wrapping MUI's `ThemeProvider` + `CssBaseline`
  - `i18n/` - Internationalization configuration
    - `i18n.ts` - i18next initialization and configuration (SSR-safe)
- **Context**: `app/context/` - React context providers
  - `UserContext/UserContext.tsx` - `UserProvider` component + `useUser()` hook for authenticated user state and `logout()`
- **Services**: `app/services/` - API service modules
  - `apiClient.ts` - Reusable API client with `apiGet`, `apiPost`, `apiPut`, `apiPatch`, `apiDelete`. Features: auto Bearer token injection, timeout (default 30s), retry with exponential backoff, `ApiError` class. See [API Client](#api-client) section
  - `authService.ts` - `login()` and `isLoggedIn()` functions using native fetch with `env.baseUrlAuth`
  - `rainloggerService.ts` - RainLogger API service using apiClient: `getRainLogs()`, `getRainLogsByDay()`
- **Utils**: `app/utils/` - Utility modules
  - `tokenStorage.ts` - localStorage wrapper for JWT token (`rainlogger_session` key): `setToken`, `getToken`, `removeToken`, `hasToken`
- **Config**: `app/config/` - Application configuration
  - `env.ts` - Centralized environment variables with type safety
- **Types**: `app/types/` - TypeScript type definitions
  - `api.ts` - Generic API response type: `ApiResponse<T>` (`{ data: T, message: string, success: boolean }`)
  - `auth.ts` - Auth domain types (`User`, `LoginRequest`, `LoginResponse`, `IsLoggedInResponse`, `AuthErrorResponse`)
  - `env.d.ts` - Environment variable type declarations for `import.meta.env`
  - `rainlogger.ts` - RainLogger domain type: `RainLog` (`{ _id, date, records?, measurement, realReading, location, timestamp, loggedBy }`)
- **Static files**: `public/` - served at root
  - `locales/` - Translation files
    - `en.json` - English translations
    - `es.json` - Spanish translations (fallback language)

## Technology Stack

- **Frontend**: React 19, TypeScript 5.9
- **Routing**: React Router 7 (framework mode)
- **UI Library**: Material UI 7 (`@mui/material`) with Emotion (`@emotion/react`, `@emotion/styled`)
- **Icons**: `@mui/icons-material`
- **Font**: Roboto via `@fontsource/roboto` (weights 300, 400, 500, 700)
- **Internationalization**: i18next 25, react-i18next 16, i18next-browser-languagedetector 8
- **Environment variables**: dotenv 17
- **Build**: Vite 7 (via `@react-router/dev/vite` plugin)
- **Testing**: Vitest 4, @testing-library/react 16, @testing-library/user-event 14, @testing-library/jest-dom 6, MSW 2 (Mock Service Worker)
- **Linting**: ESLint 9 (flat config) with TypeScript, React, jsx-a11y, testing-library, simple-import-sort, and Prettier integration
- **Formatting**: Prettier
- **Package manager**: pnpm

## Internationalization (i18n)

The project uses **i18next** for internationalization with automatic language detection and localStorage persistence.

### Configuration
- **Config file**: `app/ui/i18n/i18n.ts` - i18next initialization (imported as side effect in `root.tsx`)
- **Translation files**: `public/locales/[lang].json` (bundled with Vite, not lazy-loaded)
- **Supported languages**: Spanish (es - fallback), English (en)
- **Language detection**: Browser language + localStorage persistence (`load: 'languageOnly'` strips region codes like `en-US` → `en`)
- **SSR-safe**: Uses `typeof window !== 'undefined'` checks for React Router build compatibility

### Translation Structure
Translations are organized hierarchically:
```json
{
  "common": { "appName": "...", "loading": "...", "error": "..." },
  "pages": { "mainPage": { "title": "..." }, "login": { "title": "...", "emailLabel": "..." } },
  "components": { "languageSwitcher": { "label": "..." }, "navbar": { "title": "...", "logout": "..." }, "errorBoundary": { "message": "..." } }
}
```

### Usage Patterns

**In components:**
```typescript
import { useTranslation } from 'react-i18next';

export default function MyComponent() {
  const { t } = useTranslation();
  return <h1>{t('pages.myPage.title')}</h1>;
}
```

**For language switching:**
```typescript
const { i18n, t } = useTranslation();
i18n.changeLanguage('en');  // Switch to English
const currentLang = i18n.resolvedLanguage;  // Get current resolved language (always 'en' or 'es', never 'en-US')
```

**In meta functions (for page titles):**
```typescript
import i18n from '@/ui/i18n/i18n';

export function meta(_args: Route.MetaArgs) {
  return [{ title: i18n.t('pages.login.title') }];
}
```

### Key Features
- **Dynamic HTML lang attribute**: Updates `<html lang>` automatically when language changes (handled in `Layout` component)
- **Language switcher component**: `app/components/LanguageSwitcher/LanguageSwitcher.tsx` - Material-UI Select dropdown
- **Translated error boundaries**: ErrorBoundary uses i18n for error messages
- **Direct JSON imports**: Translation files bundled with app (no HTTP requests)

## Authentication

The project uses **JWT-based authentication** with the opensesame-back API. All routes except `/login` are protected.

### Architecture
- **Token storage**: JWT stored in localStorage via `app/utils/tokenStorage.ts` (key: `rainlogger_session`)
- **Auth service**: `app/services/authService.ts` - native `fetch` calls to the auth API
- **User context**: `app/context/UserContext/UserContext.tsx` - React context for user state across the app
- **Route protection**: `app/ui/AuthGuard/AuthGuard.tsx` - layout route that checks auth via `isLoggedIn()` API call

### Auth Flow
1. User navigates to any protected route → AuthGuard calls `GET /v1/users/isloggedin` with Bearer token
2. If no token or invalid → redirects to `/login`
3. User submits login form → `POST /v1/users/login` with `{ email, password }` and `authorizationType: bearer` header
4. On success → JWT stored in localStorage, user data set in UserContext, navigate to `/`
5. AuthGuard also populates UserContext with user data from `isloggedin` response on page refresh

### API Endpoints (opensesame-back)
- **Login**: `POST {BASE_URL_AUTH}/v1/users/login` — body: `{ email, password }`, returns `{ status, token, data: { user } }`
- **Check auth**: `GET {BASE_URL_AUTH}/v1/users/isloggedin` — header: `Authorization: Bearer <token>`, returns `{ status, message, data: { user } }`

### Usage Patterns

**Accessing user state:**
```typescript
import { useUser } from '@/context/UserContext/UserContext';

const { user, logout } = useUser();
```

**Calling auth service directly:**
```typescript
import { login, isLoggedIn } from '@/services/authService';
import { tokenStorage } from '@/utils/tokenStorage';
```

### Key Notes
- The login form uses a "Username" label but the value is sent as `email` to the API
- `UserProvider` wraps `<Outlet />` in `root.tsx` (inside `ThemeProvider`) so all routes have access to user context
- AuthGuard is a layout route defined in `app/routes.ts` using `layout()` — it wraps all protected routes and renders the `Navbar` above the page content
- No axios dependency; uses native `fetch` with a `buildHeaders()` helper for Bearer token injection

## API Client

The project uses a centralized API client (`app/services/apiClient.ts`) for all non-auth API calls. It wraps native `fetch` with typed methods, automatic Bearer token injection, timeout, and retry logic.

### Exported Methods
- **`apiGet<T>(baseUrl, endpoint, params?, config?)`** — GET with optional query params (`Record<string, string>`)
- **`apiPost<T>(baseUrl, endpoint, data?, config?)`** — POST with JSON body
- **`apiPut<T>(baseUrl, endpoint, data?, config?)`** — PUT with JSON body
- **`apiPatch<T>(baseUrl, endpoint, data?, config?)`** — PATCH with JSON body
- **`apiDelete<T>(baseUrl, endpoint, config?)`** — DELETE

### Features
- **Auto Bearer token**: Injects `Authorization: Bearer <token>` from `tokenStorage.getToken()` on every request
- **Timeout**: Default 30s, configurable via `config.timeout` (uses `AbortController`)
- **Retry**: Default 0 retries. Configurable via `config.retries` and `config.retryDelay`. Exponential backoff (`retryDelay * 2^attempt`). Retries only on: 408, 429, 500, 502, 503, 504, network errors, and abort errors
- **Error handling**: Throws `ApiError` (extends `Error`) with `status` and `data` properties for non-ok responses
- **Custom headers**: Pass `config.headers` to merge with/override defaults (`Content-Type: application/json` + Bearer token)

### Usage Pattern

```typescript
import { env } from '@/config/env';
import type { ApiResponse } from '@/types/api';
import { apiGet, apiPost } from '@/services/apiClient';

// GET with query params and retry
const logs = await apiGet<ApiResponse<Data>>(env.baseUrlRainlogger, '/v1/endpoint', { page: '1' }, { retries: 2 });

// POST with body
const result = await apiPost<ApiResponse<Data>>(env.baseUrlRainlogger, '/v1/endpoint', { field: 'value' });
```

### Key Notes
- `authService.ts` does NOT use apiClient — it has its own `buildHeaders()` and special `authorizationType: bearer` header for login
- Query params must be `Record<string, string>` — convert non-string values with `String(value)`
- The `ApiError` class is exported for use in error handling (`import { ApiError } from '@/services/apiClient'`)

### RainLogger Service (`app/services/rainloggerService.ts`)
- **`getRainLogs(startDate, endDate, location, realReading)`** — GET rain logs by date range with filters
- **`getRainLogsByDay(date, location, realReading)`** — GET rain logs for a specific day
- Both use `env.baseUrlRainlogger` as base URL, 3 retries with 2s base delay
- Return type: `ApiResponse<RainLogResponse>` where `RainLogResponse = { rainlogs: RainLog[] }`

### API Endpoints (rainlogger-back)
- **Get rain logs**: `GET {BASE_URL_RAINLOGGER}/v1/rainlogger/rainlog/filters` — query params: `dateFrom`, `dateTo`, `date`, `location`, `realReading`

## Environment Variables

The project uses **dotenv** to load environment variables from `.env` files, configured through Vite's build system.

### Configuration
- **Vite config**: `vite.config.ts` - loads dotenv and exposes variables via `define` option
- **Environment file**: `.env` - gitignored, contains sensitive values (API URLs, keys)
- **Example file**: `.env.example` - documents required environment variables for developers
- **Type definitions**: `app/types/env.d.ts` - TypeScript types for `import.meta.env`
- **Config module**: `app/config/env.ts` - centralized typed access to environment variables

### Current Environment Variables
```
NODE_ENV=development
BASE_URL_AUTH=https://polar-hamlet-58862-d62925d46f85.herokuapp.com/api
BASE_URL_RAINLOGGER=<rainlogger API URL>
```

### Usage Patterns

**Direct access (Option 1):**
```typescript
const apiUrl = import.meta.env.BASE_URL_AUTH;
const nodeEnv = import.meta.env.NODE_ENV;
```

**Using config module (Option 2 - Recommended):**
```typescript
import { env } from '@/config/env';

const authUrl = env.baseUrlAuth;
const rainloggerUrl = env.baseUrlRainlogger;
const isDev = env.isDevelopment;
const isProd = env.isProduction;
```

### Key Features
- **Type-safe**: TypeScript autocomplete and type checking for all custom environment variables
- **Build-time injection**: Variables are statically replaced during build (via Vite's `define`)
- **Centralized config**: `env` module provides single source of truth with camelCase naming
- **Vite built-ins available**: `import.meta.env.DEV`, `import.meta.env.PROD`, `import.meta.env.MODE`, `import.meta.env.SSR`

### Important Notes
- Changes to `.env` files require restarting the dev server
- For production builds, create `.env.production` with production-specific values
- Vite loads env files in priority: `.env.production.local` > `.env.production` > `.env.local` > `.env`
- Variables are baked into the bundle at build time (not loaded at runtime)
- `.env` is gitignored; use `.env.example` to document required variables

## Testing

The project uses **Vitest** with **React Testing Library** for component testing and **MSW** (Mock Service Worker) for API mocking.

### Configuration
- **Vitest config**: `vitest.config.ts` - standalone config (separate from `vite.config.ts`), uses `@vitejs/plugin-react` for JSX and `vite-tsconfig-paths` for `@/*` aliases
- **Global setup**: `app/test/setup.ts` - jest-dom matchers, i18n initialization, MSW server lifecycle, `window.matchMedia` mock for MUI
- **Custom render**: `app/test/utils/test-utils.tsx` - wraps components with `ThemeProvider` + `UserProvider` + `MemoryRouter`

### Test File Placement
Test files are **co-located** with the component they test:
```
app/components/Navbar/Navbar.tsx
app/components/Navbar/Navbar.test.tsx
```

### MSW Mock Structure
- **Mock data**: `app/test/mocks/mockData.json` - mock API responses (user, loginResponse, isLoggedInResponse, authErrorResponse)
- **Handlers**: `app/test/mocks/handlers/authHandlers.ts` - MSW v2 handlers for auth endpoints
- **Handler aggregator**: `app/test/mocks/handlers.ts` - combines all handler groups via spread
- **Server**: `app/test/mocks/server.ts` - MSW `setupServer` instance

New handler groups should be created as separate files in `app/test/mocks/handlers/` and added to the spread in `app/test/mocks/handlers.ts`.

### Usage Patterns

**Writing a component test:**
```typescript
import { i18n, render, screen, userEvent } from '@/test/utils/test-utils';

import MyComponent from '@/components/MyComponent/MyComponent';

describe('MyComponent', () => {
  it('renders translated text', () => {
    render(<MyComponent />);
    const expectedText = i18n.t('components.myComponent.title');
    expect(screen.getByText(expectedText)).toBeInTheDocument();
  });
});
```

**Overriding MSW handlers in a specific test:**
```typescript
import { http, HttpResponse } from 'msw';
import { server } from '@/test/mocks/server';

it('handles API error', async () => {
  server.use(
    http.get('http://localhost:3000/api/v1/users/isloggedin', () => {
      return HttpResponse.json({ status: 'fail', message: 'Unauthorized' }, { status: 401 });
    })
  );
  // ... test the error state
});
```

### Key Testing Rules
- **Always import `render`, `screen`, etc. from `@/test/utils/test-utils`** (not from `@testing-library/react` directly) to get provider wrapping
- **Use `i18n.t('key')` for translation assertions** — never hardcode translated strings. This makes tests language-agnostic
- **Use `userEvent.setup()` for interactions** — the ESLint rule `testing-library/prefer-user-event: 'error'` enforces this over `fireEvent`
- **Use `screen` queries** — the ESLint rule `testing-library/prefer-screen-queries: 'error'` enforces `screen.getByX` over destructured queries
- **MSW base URLs in tests** (defined in `vitest.config.ts` via `define`):
  - Auth API: `http://localhost:3000/api` (`BASE_URL_AUTH`)
  - RainLogger API: `http://localhost:3000/rainlogger-api` (`BASE_URL_RAINLOGGER`)

## Important Notes

- Uses path aliases (`@/*` maps to `app/*`) via `vite-tsconfig-paths`
- ESLint config is in `eslint.config.js` (ES module flat config)
- Build output directory: `dist/`
- `tsconfig.json` includes `rootDirs` for `.react-router/types` auto-generated route types
- Don't use `({}: Type)` destructuring pattern — use `(_args: Type)` instead to avoid `no-empty-pattern` ESLint error
- **Theming**: Only dark mode is active. The `createAppTheme(mode)` factory in `app/ui/theme/theme.ts` accepts `'dark' | 'light'` to support a future light theme. Theme palette values live in `app/ui/theme/theme.json`
- **Provider placement in `root.tsx`**: `ThemeProvider` > `UserProvider` > `<Outlet />`. `ErrorBoundary` is intentionally outside both providers
- **i18n initialization**: Side-effect import `'./ui/i18n/i18n'` must be first import in `root.tsx` (before React imports) to ensure i18n is ready before rendering
- **Component structure**: `Layout`, `ErrorBoundary`, and `AuthGuard` are separate files in `app/ui/`. `Layout` and `ErrorBoundary` are re-exported from `root.tsx` for React Router framework mode. `AuthGuard` is referenced as a layout route in `app/routes.ts`
